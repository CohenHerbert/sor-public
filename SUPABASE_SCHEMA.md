# Supabase Tables & RLS

The SQL below can be run inside the Supabase SQL Editor (or any psql session connected with a service role key) to create all tables needed by the dashboard, the edge functions in `supabase/functions`, and the row-level security policies the frontend expects.

```sql
-- ---------------------------------------------------------------------------
-- Extensions
-- ---------------------------------------------------------------------------
create extension if not exists "pgcrypto";

-- ---------------------------------------------------------------------------
-- Forms surfaced to end users
-- ---------------------------------------------------------------------------
create table if not exists public.forms (
    id bigint primary key,
    form_name text not null,
    scheduled_date timestamptz not null,
    status text not null default 'draft',
    webpage_id text not null,
    created_at timestamptz not null default now(),
    updated_at timestamptz not null default now()
);

create index if not exists idx_forms_scheduled_date on public.forms (scheduled_date desc);

-- ---------------------------------------------------------------------------
-- Registrants synced from RegFox (edge function: supabase/functions/registrants)
-- ---------------------------------------------------------------------------
create table if not exists public.registrants (
    id bigint generated by default as identity primary key,
    ext_id bigint not null,
    form_id bigint not null references public.forms (id) on delete cascade,
    first_name text,
    last_name text,
    email text,
    status text,
    created_at timestamptz not null default now(),
    unique (form_id, ext_id)
);

create index if not exists idx_registrants_email on public.registrants (lower(email));
create index if not exists idx_registrants_form on public.registrants (form_id);

-- ---------------------------------------------------------------------------
-- Memberships synced from RegFox (edge function: supabase/functions/members)
-- ---------------------------------------------------------------------------
create table if not exists public.memberships (
    id bigint generated by default as identity primary key,
    member_number bigint not null,
    first_name text,
    last_name text,
    email text,
    level_id bigint,
    fee numeric(12,2),
    status text,
    expiration_date date,
    created_at timestamptz not null default now(),
    unique (member_number)
);

create index if not exists idx_memberships_email on public.memberships (lower(email));
create index if not exists idx_memberships_status on public.memberships (status, expiration_date);

-- ---------------------------------------------------------------------------
-- RLS-independent checkpoint helpers for the edge functions
-- ---------------------------------------------------------------------------
create table if not exists public.regfox_checkpoint (
    form_id text primary key,
    last_id bigint not null default 0,
    updated_at timestamptz not null default now()
);

create table if not exists public.membership_checkpoint (
    form_id text primary key,
    last_id bigint not null default 0,
    updated_at timestamptz not null default now()
);

-- ---------------------------------------------------------------------------
-- Planner definitions consumed by the planner edge function + UI
-- ---------------------------------------------------------------------------
create table if not exists public.planners (
    id uuid primary key default gen_random_uuid(),
    name text not null,
    description text,
    questions jsonb not null default '[]'::jsonb,
    ai_context text,
    created_at timestamptz not null default now(),
    updated_at timestamptz not null default now(),
    constraint planners_questions_is_array check (jsonb_typeof(questions) = 'array')
);

create index if not exists idx_planners_name on public.planners (name);

-- ---------------------------------------------------------------------------
-- Row Level Security: enable + policies for user-facing tables
-- ---------------------------------------------------------------------------
alter table public.forms enable row level security;
alter table public.registrants enable row level security;
alter table public.memberships enable row level security;
alter table public.planners enable row level security;

-- Drop + recreate policies so this script stays idempotent.
-- FORMS ---------------------------------------------------------------------
drop policy if exists "Users can read their forms" on public.forms;
create policy "Users can read their forms"
    on public.forms
    for select
    to authenticated
    using (
        exists (
            select 1
            from public.registrants r
            where r.form_id = forms.id
              and coalesce(lower(r.email), '') = lower(coalesce(auth.email(), ''))
        )
    );

-- REGISTRANTS ---------------------------------------------------------------
drop policy if exists "Users can read matching registrant rows" on public.registrants;
create policy "Users can read matching registrant rows"
    on public.registrants
    for select
    to authenticated
    using (
        coalesce(lower(email), '') = lower(coalesce(auth.email(), ''))
    );

-- MEMBERSHIPS ---------------------------------------------------------------
drop policy if exists "Users can read their membership" on public.memberships;
create policy "Users can read their membership"
    on public.memberships
    for select
    to authenticated
    using (
        coalesce(lower(email), '') = lower(coalesce(auth.email(), ''))
    );

-- PLANNERS ------------------------------------------------------------------
drop policy if exists "Active members can read planners" on public.planners;
create policy "Active members can read planners"
    on public.planners
    for select
    to authenticated
    using (
        exists (
            select 1
            from public.memberships m
            where coalesce(lower(m.email), '') = lower(coalesce(auth.email(), ''))
              and (m.status is null or m.status ilike 'active%')
              and (m.expiration_date is null or m.expiration_date >= current_date)
        )
    );
```

> **Note:** Supabase service-role keys bypass RLS, which is why the edge functions continue to work without additional insert/update policies.
